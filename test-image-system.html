<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image System - Portuga</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #e8c13f;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #0066cc;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #e8c13f;
            color: #1a1a1a;
            font-weight: bold;
        }
        .status-ok {
            color: #28a745;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        img.test-image {
            max-width: 150px;
            max-height: 150px;
            border: 2px solid #e8c13f;
            border-radius: 8px;
        }
        button {
            background: #e8c13f;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background: #d4ab2c;
        }
        pre {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Image System</h1>
        <p>This page tests if the image upload and display system is working correctly.</p>
        
        <button onclick="runTests()">‚ñ∂ Run Tests</button>
        <button onclick="location.reload()">üîÑ Refresh</button>
        
        <div id="results"></div>
    </div>

    <script>
        // HTML escape function to prevent XSS
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Running tests...</p>';
            
            let html = '';
            let allPassed = true;

            // Test 1: Check if API is accessible
            html += '<div class="test-section">';
            html += '<h3>Test 1: API Accessibility</h3>';
            try {
                const response = await fetch('/api/admin/menu.php?action=groups');
                if (response.ok) {
                    html += '<p class="status-ok">‚úì API is accessible</p>';
                } else {
                    html += '<p class="status-error">‚úó API returned error: ' + response.status + '</p>';
                    allPassed = false;
                }
            } catch (error) {
                html += '<p class="status-error">‚úó Cannot connect to API: ' + error.message + '</p>';
                allPassed = false;
            }
            html += '</div>';

            // Test 2: Fetch menu items and check for image columns
            html += '<div class="test-section">';
            html += '<h3>Test 2: Image Columns in API Response</h3>';
            try {
                const response = await fetch('/api/admin/menu.php?action=items');
                const data = await response.json();
                
                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        const firstItem = data.data[0];
                        const hasImageData = 'image_data' in firstItem;
                        const hasImageMimeType = 'image_mime_type' in firstItem;
                        
                        if (hasImageData && hasImageMimeType) {
                            html += '<p class="status-ok">‚úì API returns image_data and image_mime_type columns</p>';
                            html += '<p>Sample item structure:</p>';
                            html += '<pre>' + JSON.stringify({
                                id: firstItem.id,
                                name: firstItem.name,
                                has_image_data: firstItem.image_data ? 'YES' : 'NO',
                                image_mime_type: firstItem.image_mime_type || 'N/A'
                            }, null, 2) + '</pre>';
                        } else {
                            html += '<p class="status-error">‚úó API response missing image columns</p>';
                            html += '<p>Fields present: ' + Object.keys(firstItem).join(', ') + '</p>';
                            allPassed = false;
                        }
                    } else {
                        html += '<p class="status-ok">‚ö† No menu items found (database is empty)</p>';
                    }
                } else {
                    html += '<p class="status-error">‚úó API returned error: ' + (data.error || 'Unknown error') + '</p>';
                    allPassed = false;
                }
            } catch (error) {
                html += '<p class="status-error">‚úó Error fetching items: ' + error.message + '</p>';
                allPassed = false;
            }
            html += '</div>';

            // Test 3: Check if items with images can be displayed
            html += '<div class="test-section">';
            html += '<h3>Test 3: Image Display</h3>';
            try {
                const response = await fetch('/api/admin/menu.php?action=items');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const itemsWithImages = data.data.filter(item => item.image_data);
                    
                    if (itemsWithImages.length > 0) {
                        html += '<p class="status-ok">‚úì Found ' + itemsWithImages.length + ' item(s) with images</p>';
                        html += '<table>';
                        html += '<tr><th>ID</th><th>Name</th><th>Image Preview</th><th>Image URL</th></tr>';
                        
                        itemsWithImages.slice(0, 5).forEach(item => {
                            const imageUrl = `/api/dish-image.php?id=${encodeURIComponent(item.id)}`;
                            html += '<tr>';
                            html += '<td>' + escapeHtml(item.id) + '</td>';
                            html += '<td>' + escapeHtml(item.name) + '</td>';
                            html += '<td><img src="' + escapeHtml(imageUrl) + '" class="test-image" onerror="this.style.border=\'2px solid red\'"></td>';
                            html += '<td><a href="' + escapeHtml(imageUrl) + '" target="_blank">View Image</a></td>';
                            html += '</tr>';
                        });
                        
                        html += '</table>';
                    } else {
                        html += '<p class="status-ok">‚ö† No items with images found (upload an image to test)</p>';
                    }
                } else {
                    html += '<p class="status-error">‚úó Cannot check images: ' + (data.error || 'Unknown error') + '</p>';
                    allPassed = false;
                }
            } catch (error) {
                html += '<p class="status-error">‚úó Error: ' + error.message + '</p>';
                allPassed = false;
            }
            html += '</div>';

            // Test 4: Check dish-image.php endpoint
            html += '<div class="test-section">';
            html += '<h3>Test 4: Image Serving Endpoint</h3>';
            try {
                // Try fetching a nonexistent image (should return default)
                const response = await fetch('/api/dish-image.php?id=99999');
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.startsWith('image/')) {
                        html += '<p class="status-ok">‚úì dish-image.php is working (returned: ' + contentType + ')</p>';
                        html += '<p>Default image test:</p>';
                        html += '<img src="/api/dish-image.php?id=99999" class="test-image" alt="Default image">';
                    } else {
                        html += '<p class="status-error">‚úó dish-image.php returned wrong content-type: ' + contentType + '</p>';
                        allPassed = false;
                    }
                } else {
                    html += '<p class="status-error">‚úó dish-image.php returned error: ' + response.status + '</p>';
                    allPassed = false;
                }
            } catch (error) {
                html += '<p class="status-error">‚úó Cannot access dish-image.php: ' + error.message + '</p>';
                allPassed = false;
            }
            html += '</div>';

            // Summary
            html += '<div class="test-section ' + (allPassed ? 'success' : 'error') + '">';
            html += '<h3>Summary</h3>';
            if (allPassed) {
                html += '<p class="status-ok">‚úÖ All tests passed! Image system is working correctly.</p>';
                html += '<p>You can now upload images in the admin panel and they should display properly.</p>';
            } else {
                html += '<p class="status-error">‚ùå Some tests failed. Please check the errors above.</p>';
                html += '<p><strong>Common fixes:</strong></p>';
                html += '<ul>';
                html += '<li>Run database migrations: <a href="/run_migrations.html">run_migrations.html</a></li>';
                html += '<li>Verify database columns are type TEXT (not BYTEA)</li>';
                html += '<li>Check that api/admin/menu.php includes image_data in queries</li>';
                html += '<li>Ensure api/dish-image.php exists and is readable</li>';
                html += '</ul>';
            }
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Run tests automatically on page load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>

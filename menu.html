<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Portuga</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Restaurant Closed Banner -->
    <div id="restaurant-closed-banner" style="display: none; background: #dc3545; color: white; text-align: center; padding: 12px; position: fixed; top: 0; width: 100%; z-index: 9999; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <strong>Restaurante Fechado</strong> - Não estamos aceitando pedidos no momento
    </div>

    <header>
        <div class="container">
            <h1>Portuga</h1>
            <p class="subtitle">Cardápio Completo</p>
        </div>
    </header>

    <nav>
        <button class="hamburger-menu" id="hamburger-btn" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <ul id="nav-menu">
            <li><a href="index.html">Início</a></li>
            <li><a href="menu.html">Cardápio</a></li>
            <li><a href="carrinho.html">Carrinho <span id="cart-badge" class="cart-badge" style="display: none;">0</span></a></li>
            <li><a href="ouvidoria.html">Fale Conosco</a></li>
            <li><a href="enviar-curriculo.html">Trabalhe Conosco</a></li>
            <li><a href="login.html">Login</a></li>
            <!--<li><a href="admin.html">Admin</a></li>-->
        </ul>
    </nav>

    <main class="container">
        <!-- Loading State -->
        <div id="menu-loading" style="text-align: center; padding: 50px;">
            <p style="color: #666; font-size: 1.2rem;">Carregando cardápio...</p>
        </div>
        
        <!-- Menu Container - dynamically populated -->
        <div id="menu-container">
            <!-- Menu sections will be loaded here -->
        </div>
        
        <!-- Empty State -->
        <div id="menu-empty" style="display: none; text-align: center; padding: 50px;">
            <h2 style="color: #999;">Nenhum item disponível no momento</h2>
            <p style="color: #666;">Por favor, volte mais tarde.</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="current-year"></span> Portuga - Restaurante & Pizzaria</p>
            <p>Sabor português com tradição brasileira</p>
            <div class="footer-propaganda">
                <p>Desenvolvido com ❤️ por <a href="mailto:wiikmy.jb@gmail.com">Seu Dev Web</a></p>
            </div>
        </div>
    </footer>

    <script src="scripts.js"></script>
    <script src="auth.js"></script>
    <script src="scripts/auth-check.js"></script>
    <script>
        // Load and display dynamic menu from database
        async function loadDynamicMenu() {
            const menuContainer = document.getElementById('menu-container');
            const menuLoading = document.getElementById('menu-loading');
            const menuEmpty = document.getElementById('menu-empty');
            
            try {
                const response = await fetch('/api/admin/menu.php?action=full-menu');
                const data = await response.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    menuLoading.style.display = 'none';
                    menuEmpty.style.display = 'block';
                    return;
                }
                
                // Organize menu by parent groups
                const menuStructure = organizeMenuStructure(data.data);
                
                // Render menu
                menuContainer.innerHTML = renderMenuStructure(menuStructure);
                menuLoading.style.display = 'none';
                menuContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading menu:', error);
                menuLoading.innerHTML = '<p style="color: #dc3545;">Erro ao carregar cardápio. Por favor, tente novamente mais tarde.</p>';
            }
        }
        
        // Organize menu into hierarchical structure
        function organizeMenuStructure(groups) {
            // Separate parent groups and subgroups
            const parentGroups = groups.filter(g => !g.parent_id);
            const subgroups = groups.filter(g => g.parent_id);
            
            // Attach subgroups and items to their parents
            parentGroups.forEach(parent => {
                parent.subgroups = subgroups.filter(sub => sub.parent_id == parent.id);
                // Items directly under parent group
                parent.directItems = (parent.items && Array.isArray(parent.items)) 
                    ? Object.values(parent.items) 
                    : [];
            });
            
            return parentGroups;
        }
        
        // Render menu structure as HTML with collapsible sections
        function renderMenuStructure(menuStructure) {
            let html = '';
            
            menuStructure.forEach((group, index) => {
                // Skip if group has no items and no subgroups with items
                const hasItems = group.directItems.length > 0;
                const hasSubgroupItems = group.subgroups && group.subgroups.some(sub => 
                    sub.items && Object.values(sub.items).length > 0
                );
                
                if (!hasItems && !hasSubgroupItems) {
                    return; // Skip empty groups
                }
                
                const groupId = `menu-group-${group.id || index}`;
                const isFirstGroup = index === 0;
                
                html += `<section class="menu-section collapsible-section">`;
                html += `
                    <h2 class="collapsible-header" onclick="toggleMenuSection('${groupId}')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>${escapeHtml(group.name)}</span>
                        <span class="collapse-icon" id="icon-${groupId}">${isFirstGroup ? '▼' : '▶'}</span>
                    </h2>
                `;
                
                html += `<div class="collapsible-content" id="${groupId}" style="display: ${isFirstGroup ? 'block' : 'none'};">`;
                
                if (group.description) {
                    html += `<p style="color: #666; margin-bottom: 20px;">${escapeHtml(group.description)}</p>`;
                }
                
                // Render direct items (items without subgroup)
                if (group.directItems.length > 0) {
                    html += `<div class="menu-items">`;
                    group.directItems.forEach(item => {
                        html += renderMenuItem(item);
                    });
                    html += `</div>`;
                }
                
                // Render subgroups with their items
                if (group.subgroups && group.subgroups.length > 0) {
                    group.subgroups.forEach((subgroup, subIndex) => {
                        const subItems = subgroup.items ? Object.values(subgroup.items) : [];
                        
                        if (subItems.length > 0) {
                            const subgroupId = `subgroup-${group.id}-${subgroup.id || subIndex}`;
                            const isFirstSubgroup = subIndex === 0;
                            
                            html += `
                                <h3 class="collapsible-header" onclick="toggleMenuSection('${subgroupId}')" 
                                    style="margin-top: 30px; margin-bottom: 15px; color: #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px;">
                                    <span>${escapeHtml(subgroup.name)}</span>
                                    <span class="collapse-icon" id="icon-${subgroupId}" style="font-size: 0.8em;">${isFirstSubgroup ? '▼' : '▶'}</span>
                                </h3>
                            `;
                            
                            html += `<div class="collapsible-content" id="${subgroupId}" style="display: ${isFirstSubgroup ? 'block' : 'none'};">`;
                            
                            if (subgroup.description) {
                                html += `<p style="color: #666; margin-bottom: 15px;">${escapeHtml(subgroup.description)}</p>`;
                            }
                            
                            html += `<div class="menu-items">`;
                            subItems.forEach(item => {
                                html += renderMenuItem(item);
                            });
                            html += `</div>`;
                            html += `</div>`; // Close collapsible-content
                        }
                    });
                }
                
                html += `</div>`; // Close collapsible-content
                html += `</section>`;
            });
            
            return html || '<p style="text-align: center; color: #666; padding: 40px;">Nenhum item disponível no momento.</p>';
        }
        
        // Toggle menu section visibility
        function toggleMenuSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(`icon-${sectionId}`);
            
            if (content && icon) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.textContent = '▼';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '▶';
                }
            }
        }
        
        // Render a single menu item
        function renderMenuItem(item) {
            // Use dish-image.php endpoint which handles BLOB/default.png fallback
            const imageUrl = `/api/dish-image.php?id=${item.id}`;
            const fallbackUrl = item.image_url || '/images/default.png';
            const price = parseFloat(item.price).toFixed(2);
            const itemId = parseInt(item.id) || 0;
            
            return `
                <div class="product-card">
                    <img src="${imageUrl}" 
                         alt="${escapeHtml(item.name)}" 
                         class="product-image" 
                         onerror="this.src='${escapeHtml(fallbackUrl)}'">
                    <div class="product-info">
                        <h3 class="product-name">${escapeHtml(item.name)}</h3>
                        <p class="product-description">${escapeHtml(item.description || '')}</p>
                        <p class="product-price">R$ ${price}</p>
                        <button class="btn" data-item-id="${itemId}" data-item-name="${escapeHtml(item.name)}" data-item-price="${price}" data-item-image="${imageUrl}">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // Update navigation UI and load menu on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Set current year
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();
            
            await updateNavigationUI();
            await loadDynamicMenu();
            
            // Add event delegation for Add to Cart buttons
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('btn') && e.target.hasAttribute('data-item-name')) {
                    const itemName = e.target.getAttribute('data-item-name');
                    const itemPrice = parseFloat(e.target.getAttribute('data-item-price'));
                    const itemImage = e.target.getAttribute('data-item-image');
                    addToCart(itemName, itemPrice, itemImage);
                }
            });
        });
    </script>
</body>
</html>